# CNB äº‘åŸç”Ÿæ„å»ºé…ç½®æ–‡ä»¶
# ç”¨äºè‡ªåŠ¨æ‰“åŒ… Electron åº”ç”¨ï¼ˆå¤šå¹³å°ï¼‰

# åˆ†æ”¯å
main:
  # äº‹ä»¶ï¼šä»£ç æ¨é€æ—¶è§¦å‘
  push:
    # Windows æ„å»ºæµæ°´çº¿
    - name: build-windows
      # Docker ç¯å¢ƒ
      docker:
        image: node:18
        # ç¼“å­˜ node_modulesï¼ˆä½¿ç”¨å†™æ—¶å¤åˆ¶ï¼‰
        volumes:
          - node_modules:copy-on-write

      # ç¯å¢ƒå˜é‡
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"

      # æ„å»ºæ­¥éª¤ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
      stages:
        - name: å®‰è£…ä¾èµ–
          script: |
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm ci

        - name: æ„å»ºå‰ç«¯
          script: |
            echo "ğŸ¨ æ„å»ºå‰ç«¯..."
            npm run build:renderer

        - name: æ„å»ºä¸»è¿›ç¨‹
          script: |
            echo "âš™ï¸ æ„å»ºä¸»è¿›ç¨‹..."
            npm run build:main

        - name: æ‰“åŒ… Windows åº”ç”¨
          script: |
            echo "ğŸ“¦ æ‰“åŒ… Windows åº”ç”¨..."
            npm run pack
            echo "âœ… Windows æ‰“åŒ…å®Œæˆ"
            ls -lh build-output/ || true

        - name: æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          script: |
            echo "=== Windows æ‰“åŒ…äº§ç‰© ==="
            find build-output -type f -name "*.exe" || true

        - name: å‹ç¼©æ„å»ºäº§ç‰©
          script: |
            echo "ğŸ“¦ å‹ç¼©æ„å»ºäº§ç‰©..."
            cd build-output
            zip -r windows-build.zip win-unpacked/
            ls -lh windows-build.zip
            mv windows-build.zip ..
            cd ..

        - name: åˆ›å»ºæˆ–æ›´æ–° Tag
          script: |
            echo "ğŸ·ï¸ åˆ›å»º Tag..."
            git config user.name "CNB Bot"
            git config user.email "cnb@bot.com"
            # åˆ é™¤æœ¬åœ°å’Œè¿œç¨‹çš„æ—§ tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            git tag -d windows-latest || true
            git push origin :refs/tags/windows-latest || true
            # åˆ›å»ºæ–° tag
            git tag -a windows-latest -m "Windows æ„å»ºäº§ç‰© - $(date +"%Y-%m-%d %H:%M:%S")"
            git push origin windows-latest

        - name: åˆ›å»º Release
          type: git:release
          options:
            tag: "windows-latest"
            title: "Windows æ„å»ºäº§ç‰© - æœ€æ–°ç‰ˆ"
            description: |
              ## Windows å®¢æˆ·ç«¯æ„å»ºäº§ç‰©

              **æ„å»ºä¿¡æ¯**ï¼š
              - æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S")
              - åˆ†æ”¯: ${CNB_BRANCH}
              - æäº¤: ${CNB_COMMIT_SHORT}

              **ä¸‹è½½è¯´æ˜**ï¼š
              - ä¸‹è½½ `windows-build.zip`
              - è§£å‹åè¿è¡Œ `win-unpacked/Cloudflareéš§é“ç®¡ç†å™¨.exe`

        - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            tag: "windows-latest"
            files:
              - windows-build.zip

    # Linux æ„å»ºæµæ°´çº¿
    - name: build-linux
      # Docker ç¯å¢ƒ
      docker:
        image: node:18
        # ç¼“å­˜ node_modulesï¼ˆä½¿ç”¨å†™æ—¶å¤åˆ¶ï¼‰
        volumes:
          - node_modules:copy-on-write

      # ç¯å¢ƒå˜é‡
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"

      # æ„å»ºæ­¥éª¤
      stages:
        - name: å®‰è£…ä¾èµ–
          script: |
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm ci

        - name: æ„å»ºå‰ç«¯
          script: |
            echo "ğŸ¨ æ„å»ºå‰ç«¯..."
            npm run build:renderer

        - name: æ„å»ºä¸»è¿›ç¨‹
          script: |
            echo "âš™ï¸ æ„å»ºä¸»è¿›ç¨‹..."
            npm run build:main

        - name: æ‰“åŒ… Linux åº”ç”¨
          script: |
            echo "ğŸ“¦ æ‰“åŒ… Linux åº”ç”¨..."
            npm run build:linux
            echo "âœ… Linux æ‰“åŒ…å®Œæˆ"
            ls -lh build-output/ || true

        - name: æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          script: |
            echo "=== Linux æ‰“åŒ…äº§ç‰© ==="
            find build-output -type f -name "*.AppImage" -o -name "*.deb" || true

        - name: åˆ›å»ºæˆ–æ›´æ–° Tag
          script: |
            echo "ğŸ·ï¸ åˆ›å»º Tag..."
            git config user.name "CNB Bot"
            git config user.email "cnb@bot.com"
            # åˆ é™¤æœ¬åœ°å’Œè¿œç¨‹çš„æ—§ tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            git tag -d linux-latest || true
            git push origin :refs/tags/linux-latest || true
            # åˆ›å»ºæ–° tag
            git tag -a linux-latest -m "Linux æ„å»ºäº§ç‰© - $(date +"%Y-%m-%d %H:%M:%S")"
            git push origin linux-latest

        - name: åˆ›å»º Release
          type: git:release
          options:
            tag: "linux-latest"
            title: "Linux æ„å»ºäº§ç‰© - æœ€æ–°ç‰ˆ"
            description: |
              ## Linux å®¢æˆ·ç«¯æ„å»ºäº§ç‰©

              **æ„å»ºä¿¡æ¯**ï¼š
              - æ„å»ºæ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S")
              - åˆ†æ”¯: ${CNB_BRANCH}
              - æäº¤: ${CNB_COMMIT_SHORT}

              **ä¸‹è½½è¯´æ˜**ï¼š
              - AppImage: æ— éœ€å®‰è£…ï¼Œæ·»åŠ æ‰§è¡Œæƒé™åç›´æ¥è¿è¡Œ
              - deb: Debian/Ubuntu ç³»ç»Ÿä½¿ç”¨ `dpkg -i` å®‰è£…

        - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            tag: "linux-latest"
            files:
              - build-output/*.AppImage
              - build-output/*.deb

