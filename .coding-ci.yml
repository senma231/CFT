# CNB äº‘åŸç”Ÿæ„å»ºé…ç½®æ–‡ä»¶
# ç”¨äºè‡ªåŠ¨æ‰“åŒ… Electron åº”ç”¨ï¼ˆå¤šå¹³å°ï¼‰

# åˆ†æ”¯å
main:
  # äº‹ä»¶ï¼šä»£ç æ¨é€æ—¶è§¦å‘
  push:
    # Windows æ„å»ºæµæ°´çº¿
    - name: build-windows
      # Docker ç¯å¢ƒ
      docker:
        image: node:18
        # ç¼“å­˜ node_modulesï¼ˆä½¿ç”¨å†™æ—¶å¤åˆ¶ï¼‰
        volumes:
          - node_modules:copy-on-write

      # ç¯å¢ƒå˜é‡
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"

      # æ„å»ºæ­¥éª¤ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
      stages:
        - name: å®‰è£…ä¾èµ–
          script: |
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm ci

        - name: æ„å»ºå‰ç«¯
          script: |
            echo "ğŸ¨ æ„å»ºå‰ç«¯..."
            npm run build:renderer

        - name: æ„å»ºä¸»è¿›ç¨‹
          script: |
            echo "âš™ï¸ æ„å»ºä¸»è¿›ç¨‹..."
            npm run build:main

        - name: æ‰“åŒ… Windows åº”ç”¨
          script: |
            echo "ğŸ“¦ æ‰“åŒ… Windows åº”ç”¨..."
            npm run pack
            echo "âœ… Windows æ‰“åŒ…å®Œæˆ"
            ls -lh build-output/ || true

        - name: æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          script: |
            echo "=== Windows æ‰“åŒ…äº§ç‰© ==="
            find build-output -type f -name "*.exe" || true

      # ä¿å­˜æ„å»ºäº§ç‰©
      artifacts:
        - build-output/**/*

    # Linux æ„å»ºæµæ°´çº¿
    - name: build-linux
      # Docker ç¯å¢ƒ
      docker:
        image: node:18
        # ç¼“å­˜ node_modulesï¼ˆä½¿ç”¨å†™æ—¶å¤åˆ¶ï¼‰
        volumes:
          - node_modules:copy-on-write

      # ç¯å¢ƒå˜é‡
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"

      # æ„å»ºæ­¥éª¤
      stages:
        - name: å®‰è£…ä¾èµ–
          script: |
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            npm ci

        - name: æ„å»ºå‰ç«¯
          script: |
            echo "ğŸ¨ æ„å»ºå‰ç«¯..."
            npm run build:renderer

        - name: æ„å»ºä¸»è¿›ç¨‹
          script: |
            echo "âš™ï¸ æ„å»ºä¸»è¿›ç¨‹..."
            npm run build:main

        - name: æ‰“åŒ… Linux åº”ç”¨
          script: |
            echo "ğŸ“¦ æ‰“åŒ… Linux åº”ç”¨..."
            npm run build:linux
            echo "âœ… Linux æ‰“åŒ…å®Œæˆ"
            ls -lh build-output/ || true

        - name: æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          script: |
            echo "=== Linux æ‰“åŒ…äº§ç‰© ==="
            find build-output -type f -name "*.AppImage" -o -name "*.deb" || true

      # ä¿å­˜æ„å»ºäº§ç‰©
      artifacts:
        - build-output/**/*

