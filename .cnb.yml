# CNB äº‘åŸç”Ÿæ„å»ºé…ç½®æ–‡ä»¶
# ç”¨äºè‡ªåŠ¨æ‰“åŒ… Electron åº”ç”¨ï¼ˆå¤šå¹³å°ï¼‰

# å…¨å±€é…ç½®
$:
  # Windows éƒ¨ç½²äº‹ä»¶ï¼ˆé€šè¿‡ Tag éƒ¨ç½²é¡µé¢è§¦å‘ï¼‰
  tag_deploy.windows:
    - name: deploy-windows
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"
      stages:
        - name: å®‰è£…ç³»ç»Ÿä¾èµ–
          script: |
            apt-get update
            apt-get install -y zip

        - name: å®‰è£…ä¾èµ–
          script: npm ci

        - name: æ„å»ºå‰ç«¯
          script: npm run build:renderer

        - name: æ„å»ºä¸»è¿›ç¨‹
          script: npm run build:main

        - name: æ‰“åŒ… Windows åº”ç”¨
          script: |
            npx electron-builder --win --dir
            echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
            ls -lh build-output/

        - name: å‹ç¼©æ„å»ºäº§ç‰©
          script: |
            cd build-output
            zip -r windows-build.zip win-unpacked/
            mv windows-build.zip ..
            cd ..
            echo "=== å‹ç¼©å®Œæˆ ==="
            ls -lh windows-build.zip

        - name: ä¸Šä¼ åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            tag: $TAG_NAME
            files:
              - windows-build.zip

  # Linux éƒ¨ç½²äº‹ä»¶ï¼ˆé€šè¿‡ Tag éƒ¨ç½²é¡µé¢è§¦å‘ï¼‰
  tag_deploy.linux:
    - name: deploy-linux
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci

        - name: æ„å»ºå‰ç«¯
          script: npm run build:renderer

        - name: æ„å»ºä¸»è¿›ç¨‹
          script: npm run build:main

        - name: æ‰“åŒ… Linux åº”ç”¨
          script: npm run build:linux

        - name: ä¸Šä¼ åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            tag: $TAG_NAME
            files:
              - build-output/*.AppImage
              - build-output/*.deb

  # å…¨å¹³å°éƒ¨ç½²äº‹ä»¶ï¼ˆé€šè¿‡ Tag éƒ¨ç½²é¡µé¢è§¦å‘ï¼‰
  tag_deploy.all:
    - name: deploy-all-windows
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"
      stages:
        - name: å®‰è£…ç³»ç»Ÿä¾èµ–
          script: |
            apt-get update
            apt-get install -y zip

        - name: å®‰è£…ä¾èµ–
          script: npm ci

        - name: æ„å»ºå‰ç«¯
          script: npm run build:renderer

        - name: æ„å»ºä¸»è¿›ç¨‹
          script: npm run build:main

        - name: æ‰“åŒ… Windows åº”ç”¨
          script: |
            npx electron-builder --win --dir
            echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
            ls -lh build-output/

        - name: å‹ç¼©æ„å»ºäº§ç‰©
          script: |
            cd build-output
            zip -r windows-build.zip win-unpacked/
            mv windows-build.zip ..
            cd ..
            echo "=== å‹ç¼©å®Œæˆ ==="
            ls -lh windows-build.zip

        - name: ä¸Šä¼  Windows äº§ç‰©åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            tag: $TAG_NAME
            files:
              - windows-build.zip

    - name: deploy-all-linux
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci

        - name: æ„å»ºå‰ç«¯
          script: npm run build:renderer

        - name: æ„å»ºä¸»è¿›ç¨‹
          script: npm run build:main

        - name: æ‰“åŒ… Linux åº”ç”¨
          script: npm run build:linux

        - name: ä¸Šä¼  Linux äº§ç‰©åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            tag: $TAG_NAME
            files:
              - build-output/*.AppImage
              - build-output/*.deb

# åˆ†æ”¯å
main:
  # äº‹ä»¶ï¼šä»£ç æ¨é€æ—¶è§¦å‘ï¼ˆä»…åšä»£ç æ£€æŸ¥ï¼Œä¸æ„å»ºï¼‰
  push:
    - name: code-check
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci

        - name: ä»£ç æ£€æŸ¥
          script: |
            echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
            echo "ğŸ’¡ æç¤ºï¼šåˆ›å»º Tag åï¼Œåœ¨ã€éƒ¨ç½²ã€‘é¡µé¢é€‰æ‹©ç¯å¢ƒè¿›è¡Œéƒ¨ç½²"

