# CNB äº‘åŸç”Ÿæ„å»ºé…ç½®æ–‡ä»¶
# ç”¨äºè‡ªåŠ¨æ‰“åŒ… Electron åº”ç”¨ï¼ˆå¤šå¹³å°ï¼‰

# å…¨å±€é…ç½®
$:
  # Windows éƒ¨ç½²äº‹ä»¶ï¼ˆé€šè¿‡ Tag éƒ¨ç½²é¡µé¢è§¦å‘ï¼‰
  tag_deploy.windows:
    - name: deploy-windows
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"
        # è®© electron-builder ä¸‹è½½ Windows ç‰ˆæœ¬çš„ Electron
        USE_HARD_LINKS: "false"
      stages:
        - name: å®‰è£…ç³»ç»Ÿä¾èµ–
          script: |
            apt-get update
            apt-get install -y zip wine wine64

        - name: å®‰è£…ä¾èµ–
          script: |
            npm ci
            # ä¸‹è½½ Windows ç‰ˆæœ¬çš„ Electron
            npx electron-builder install-app-deps --platform=win32 --arch=x64

        - name: æ„å»ºå‰ç«¯
          script: npm run build:renderer

        - name: æ‰“åŒ… Windows åº”ç”¨
          script: |
            npx electron-builder --win --dir --x64
            echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
            ls -lh build-output/
            echo "=== win-unpacked å†…å®¹ ==="
            ls -lh build-output/win-unpacked/ | head -20

        - name: å‹ç¼©æ„å»ºäº§ç‰©
          script: |
            cd build-output
            zip -r windows-build.zip win-unpacked/
            mv windows-build.zip ..
            cd ..
            echo "=== å‹ç¼©å®Œæˆ ==="
            ls -lh windows-build.zip
            echo "=== å½“å‰ç›®å½• ==="
            pwd
            echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
            ls -lh *.zip || echo "æ²¡æœ‰æ‰¾åˆ° zip æ–‡ä»¶"

        - name: åˆ›å»º Release
          type: git:release
          options:
            tag: $TAG_NAME
            title: "Windows å®¢æˆ·ç«¯ $TAG_NAME"
            description: "Cloudflare éš§é“ç®¡ç†å™¨ Windows å®¢æˆ·ç«¯"

        - name: ä¸Šä¼ åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            attachments:
              - windows-build.zip

  # Linux éƒ¨ç½²äº‹ä»¶ï¼ˆé€šè¿‡ Tag éƒ¨ç½²é¡µé¢è§¦å‘ï¼‰
  tag_deploy.linux:
    - name: deploy-linux
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci

        - name: æ„å»ºå‰ç«¯
          script: npm run build:renderer

        - name: æ‰“åŒ… Linux åº”ç”¨
          script: |
            npx electron-builder --linux --x64
            echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
            ls -lh build-output/

        - name: åˆ›å»º Release
          type: git:release
          options:
            tag: $TAG_NAME
            title: "Linux å®¢æˆ·ç«¯ $TAG_NAME"
            description: "Cloudflare éš§é“ç®¡ç†å™¨ Linux å®¢æˆ·ç«¯"

        - name: ä¸Šä¼ åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            attachments:
              - build-output/*.AppImage
              - build-output/*.deb

  # å…¨å¹³å°éƒ¨ç½²äº‹ä»¶ï¼ˆé€šè¿‡ Tag éƒ¨ç½²é¡µé¢è§¦å‘ï¼‰
  tag_deploy.all:
    - name: deploy-all-windows
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"
        USE_HARD_LINKS: "false"
      stages:
        - name: å®‰è£…ç³»ç»Ÿä¾èµ–
          script: |
            apt-get update
            apt-get install -y zip wine wine64

        - name: å®‰è£…ä¾èµ–
          script: |
            npm ci
            # ä¸‹è½½ Windows ç‰ˆæœ¬çš„ Electron
            npx electron-builder install-app-deps --platform=win32 --arch=x64

        - name: æ„å»ºå‰ç«¯
          script: npm run build:renderer

        - name: æ‰“åŒ… Windows åº”ç”¨
          script: |
            npx electron-builder --win --dir --x64
            echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
            ls -lh build-output/
            echo "=== win-unpacked å†…å®¹ ==="
            ls -lh build-output/win-unpacked/ | head -20

        - name: å‹ç¼©æ„å»ºäº§ç‰©
          script: |
            cd build-output
            zip -r windows-build.zip win-unpacked/
            mv windows-build.zip ..
            cd ..
            echo "=== å‹ç¼©å®Œæˆ ==="
            ls -lh windows-build.zip
            echo "=== å½“å‰ç›®å½• ==="
            pwd
            echo "=== æ–‡ä»¶åˆ—è¡¨ ==="
            ls -lh *.zip || echo "æ²¡æœ‰æ‰¾åˆ° zip æ–‡ä»¶"

        - name: åˆ›å»º Release (Windows)
          type: git:release
          options:
            tag: $TAG_NAME
            title: "å…¨å¹³å°å®¢æˆ·ç«¯ $TAG_NAME"
            description: "Cloudflare éš§é“ç®¡ç†å™¨ - Windows å’Œ Linux å®¢æˆ·ç«¯"
            overlying: true

        - name: ä¸Šä¼  Windows äº§ç‰©åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            attachments:
              - windows-build.zip

    - name: deploy-all-linux
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      env:
        CSC_IDENTITY_AUTO_DISCOVERY: "false"
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci

        - name: æ„å»ºå‰ç«¯
          script: npm run build:renderer

        - name: æ‰“åŒ… Linux åº”ç”¨
          script: |
            npx electron-builder --linux --x64
            echo "=== æ„å»ºäº§ç‰©åˆ—è¡¨ ==="
            ls -lh build-output/

        - name: åˆ›å»º Release (Linux)
          type: git:release
          options:
            tag: $TAG_NAME
            title: "å…¨å¹³å°å®¢æˆ·ç«¯ $TAG_NAME"
            description: "Cloudflare éš§é“ç®¡ç†å™¨ - Windows å’Œ Linux å®¢æˆ·ç«¯"
            overlying: true

        - name: ä¸Šä¼  Linux äº§ç‰©åˆ° Release
          image: cnbcool/attachments:latest
          settings:
            attachments:
              - build-output/*.AppImage
              - build-output/*.deb

# åˆ†æ”¯å
main:
  # äº‹ä»¶ï¼šä»£ç æ¨é€æ—¶è§¦å‘ï¼ˆä»…åšä»£ç æ£€æŸ¥ï¼Œä¸æ„å»ºï¼‰
  push:
    - name: code-check
      docker:
        image: node:18
        volumes:
          - node_modules:copy-on-write
      stages:
        - name: å®‰è£…ä¾èµ–
          script: npm ci

        - name: ä»£ç æ£€æŸ¥
          script: |
            echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
            echo "ğŸ’¡ æç¤ºï¼šåˆ›å»º Tag åï¼Œåœ¨ã€éƒ¨ç½²ã€‘é¡µé¢é€‰æ‹©ç¯å¢ƒè¿›è¡Œéƒ¨ç½²"

